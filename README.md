# SMKPLOT - Emissions Visualization Tool

A comprehensive tool for visualizing emissions data from SMOKE reports, FF10 files, NetCDF, and CSV formats. Supports both interactive GUI and automated batch processing modes.

## Features

*   **Dual Mode Operation**: Interactive GUI for exploration or headless batch mode for automation
*   **Multiple Data Formats**: SMOKE reports, FF10 point/nonpoint, NetCDF (including inline sources), CSV/TXT
*   **Flexible Plotting**: County-based (FIPS) or grid-based visualization
*   **Spatial Filtering**: Filter data by geographic regions using overlay shapefiles with robust boundary detection
*   **Projections**: Automatic projection handling (WGS84, Lambert Conformal Conic)
*   **Configuration Management**: Save/load complete run configurations via YAML/JSON
*   **Parallel Processing**: Multi-core batch processing for large datasets

## Installation

### Prerequisites
*   Python 3.9 or higher
*   `tkinter` for GUI mode (usually included; on Linux: `sudo apt-get install python3-tk`)

### Quick Setup

Use the provided installation script:
```bash
./install.sh
```

This creates a virtual environment, installs dependencies, and configures the tool.

### Manual Installation

```bash
python3 -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate
pip install -r requirements.txt
```

## Usage

### GUI Mode

Launch the interactive interface:
```bash
./smkplot.py
# OR with a data file
./smkplot.py -f emissions.csv
```

The GUI provides:
*   File selection and preview
*   Interactive plot settings (colormap, scale, bins)
*   Spatial filtering controls
*   Real-time plot generation

### Batch Mode

Generate plots automatically without GUI:

**Basic County Plot:**
```bash
./smkplot.py --run-mode batch \
  -f emissions.csv \
  --county-shapefile counties.gpkg \
  --pollutant "NOX,VOC,PM2_5" \
  --outdir ./output_maps
```

**Grid Plot:**
```bash
./smkplot.py --run-mode batch \
  --pltyp grid \
  --griddesc GRIDDESC.txt \
  --gridname 12US1_459X299 \
  -f emissions.csv \
  --pollutant CO \
  --outdir ./grid_maps
```

**With Spatial Filtering:**
```bash
./smkplot.py --run-mode batch \
  -f emissions.csv \
  --county-shapefile counties.gpkg \
  --overlay-shapefile California.shp \
  --filtered-by-overlay within \
  --pollutant NOX \
  --outdir ./ca_maps
```

### Configuration Files

Configuration files allow you to save complete run settings for reproducibility.

**Using a Configuration File:**

Simply pass a `.yaml` or `.json` file to `-f` / `--filepath`. The tool automatically detects configuration files by extension:

```bash
./smkplot.py -f my_config.yaml
```

**Configuration File Structure:**

```yaml
timestamp_utc: '2026-01-21T12:00:00Z'
arguments:
  filepath: /path/to/emissions.csv
  sector: my_sector
  county_shapefile: /path/to/counties.gpkg
  overlay_shapefile: /path/to/state_lines.shp; /path/to/major_roads.shp
  filter_shapefile: /path/to/my_region.shp
  filter_shapefile_opt: within
  pltyp: county
  pollutant: NOX,VOC
  cmap: viridis
  log_scale: true
  zoom_to_data: true
  outdir: ./outputs
  export_csv: true
outputs:
  # Auto-generated by the tool
```

**Note:** Batch mode automatically saves a configuration snapshot after each run for easy replication.

## Command Line Arguments

### Input/Output
| Argument | Description |
| :--- | :--- |
| `-f`, `--filepath` | Path to emissions file (CSV, TXT, NetCDF, FF10) **OR** configuration file (`.yaml`, `.json`) |
| `--sector` | Sector name for output file prefixes |
| `--outdir` | Output directory (default: `outputs`) |
| `--export-csv` | Export processed data to CSV |

### Execution Mode
| Argument | Description |
| :--- | :--- |
| `--run-mode` | Execution mode: `gui` or `batch` (auto-detected if omitted) |
| `--self-test` | Run synthetic data test to verify installation |
| `--workers` | Number of parallel workers for batch (0=auto, default) |

### Plot Settings
| Argument | Description |
| :--- | :--- |
| `--pltyp` | Plot type: `county` (default) or `grid` |
| `--pollutant` | Pollutant(s) to plot (comma/space-separated) |
| `--cmap` | Colormap name (default: `viridis`; e.g., `jet`, `plasma`, `turbo`) |
| `--log-scale` | Use logarithmic color scale |
| `--bins` | Custom colorbar bin edges (comma/space-separated) |
| `--fill-nan` | Value for missing data (e.g., `0.0`) |
| `--zoom-to-data` | Zoom to data extent (auto-enabled with spatial filtering) |
| `--zoom-pad` | Padding fraction for zoom (default: 0.02) |

### Geometry & Projections
| Argument | Description |
| :--- | :--- |
| `--county-shapefile` | Path to county boundary shapefile (required for county plots) |
| `--griddesc` | Path to GRIDDESC file (required for grid plots, except NetCDF) |
| `--gridname` | Grid name from GRIDDESC |
| `--overlay-shapefile` | Path to overlay shapefile (can specify multiple times) |
| `--projection` | Projection mode: `auto` (default), `wgs84`, or `lcc` |
| `--force-lcc` | Force legacy CONUS LCC projection (deprecated) |

### Spatial Filtering
| Argument | Description |
| :--- | :--- |
| `--filter-shapefile` | Path/URL to shapefile(s) for spatial filtering (can specify multiple times) |
| `--filter-shapefile-opt` | Filter operation: `within`, `intersect`, or `clipped` (default: `intersect`) |
| `--filtered-by-overlay` | [DEPRECATED] Use `--filter-shapefile-opt` instead |

**Filter Operations:**
*   **`within`**: Keeps features whose center (centroid/representative point) is inside the filter shapefile.
*   **`intersect`**: Keeps features that touch any part of the filter shapefile.
*   **`clipped`**: Geometrically clips features (like grid cells) to match the filter shapefile boundary.

### Data Filtering
| Argument | Description |
| :--- | :--- |
| `--filter-col` | Column name to filter by (e.g., `SCC`, `region_cd`) |
| `--filter-start` | Start value for range filter (inclusive) |
| `--filter-end` | End value for range filter (inclusive) |
| `--filter-val` | Discrete value(s) to keep (repeat flag or use commas) |

### File Parsing
| Argument | Description |
| :--- | :--- |
| `--delim` | Delimiter: `comma`, `tab`, `pipe`, `semicolon`, or literal character |
| `--skiprows` | Skip first N lines before header |
| `--comment` | Comment character (e.g., `#`) |
| `--encoding` | File encoding (e.g., `utf-8`, `latin1`) |

### NetCDF Options
| Argument | Description |
| :--- | :--- |
| `--ncf-tdim` | Time dimension operation: `avg`, `sum`, `max`, `min`, or index (default: `avg`) |
| `--ncf-zdim` | Layer dimension operation: `avg`, `sum`, `max`, `min`, or index (default: `0`) |
| `--stack-groups` | Path to STACK_GROUPS file for inline point sources |

### Logging
| Argument | Description |
| :--- | :--- |
| `--log-level` | Verbosity: `DEBUG`, `INFO` (default), `WARNING`, `ERROR`, `CRITICAL` |
| `--log-file` | Write logs to file (appends; creates timestamped file if directory given) |

## Advanced Features

### Multiple Overlays and Filters
You can specify multiple shapefiles for either visual overlays or spatial filters:
*   **CLI**: Use the flag multiple times: `--overlay-shapefile file1.shp --overlay-shapefile file2.shp`
*   **GUI**: Separate paths with semicolons: `/path/to/file1.shp; /path/to/file2.shp`
*   **Automatic Coloring**: Visual overlays are automatically assigned distinct colors (cyan, magenta, yellow, etc.) to differentiate between boundaries.

### Spatial Filtering with Dual-Check Strategy
The `within` filter mode uses a robust dual-check approach:
1.  Checks if feature **centroid** is within overlay
2.  Checks if feature **representative point** is within overlay
3.  Includes feature if **either** check passes

This ensures accurate filtering for complex geometries like coastal counties where centroids may fall in water.

### Automatic Zoom Behavior
When spatial filtering is active (using `--filter-shapefile-opt`), the tool automatically enables `--zoom-to-data` to focus the map on the filtered region, eliminating empty space.

### NetCDF Grid Handling
NetCDF files (including inline point sources) automatically derive grid parameters from file headers. External `--griddesc` arguments are ignored for NetCDF inputs.

### Warning Management
Python warnings (e.g., from matplotlib, geopandas) are captured and routed through the logging system, respecting the `--log-level` setting.

## Troubleshooting

| Issue | Solution |
| :--- | :--- |
| **"No module named 'tkinter'"** | Install: `sudo apt-get install python3-tk` (Linux) or reinstall Python with Tk support |
| **"No module named 'yaml'"** | Install: `pip install PyYAML` |
| **Display issues on remote server** | Use `--run-mode batch` to force headless operation |
| **Missing counties in spatial filter** | Verify overlay shapefile CRS matches data; try `intersect` mode |
| **Tight layout warnings** | These are now handled internally and can be ignored |
| **Empty plots** | Check that pollutant names match data columns exactly (case-sensitive) |

## Examples

**1. Quick GUI exploration:**
```bash
./smkplot.py -f report.csv
```

**2. Batch process multiple pollutants:**
```bash
./smkplot.py --run-mode batch \
  -f emissions.csv \
  --county-shapefile counties.gpkg \
  --pollutant "NOX,VOC,SO2,PM2_5" \
  --cmap jet \
  --log-scale \
  --outdir ./batch_output
```

**3. Powerful Spatial Filtering (State-specific analysis):**
```bash
./smkplot.py --run-mode batch \
  -f national_emissions.csv \
  --county-shapefile us_counties.gpkg \
  --filter-shapefile texas.shp \
  --filter-shapefile-opt within \
  --pollutant NOX \
  --zoom-to-data \
  --outdir ./texas_maps
```

**4. Grid plotting with NetCDF:**
```bash
./smkplot.py --run-mode batch \
  -f CCTM_output.nc \
  --pltyp grid \
  --pollutant NO2 \
  --ncf-tdim avg \
  --ncf-zdim 0 \
  --outdir ./netcdf_maps
```

**5. Multiple Visual Overlays:**
```bash
./smkplot.py --run-mode batch \
  -f report.csv \
  --overlay-shapefile state_lines.shp \
  --overlay-shapefile pipelines.shp \
  --pollutant CO
```

**6. Reuse saved configuration:**
```bash
./smkplot.py -f previous_run.yaml
```
