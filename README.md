# SMKPLOT GUI & Batch Plotting Tool

This tool provides a graphical user interface (GUI) and a headless batch mode for visualizing emissions data from SMOKE reports, FF10 files, and other CSV/text formats. It supports plotting by county (using FIPS codes) or by grid (using IOAPI GRIDDESC definitions).

## Features

*   **Interactive GUI**: Explore data, filter by sector/SCC, customize plot settings (colormap, scale, bins), and export plots.
*   **Batch Mode**: Automate map generation for multiple pollutants and datasets via command-line arguments or configuration files.
*   **Configuration Support**: Save and load run configurations using JSON or YAML files for reproducibility.
*   **Data Formats**: Supports SMOKE reports, FF10 point/nonpoint files, and generic CSVs with flexible delimiter detection.
*   **Projections**: Supports geographic (WGS84) and Lambert Conformal Conic (LCC) projections.
*   **Filtering**: Filter data by column values (e.g., specific FIPS, SCCs) or ranges.

## Installation

1.  **Prerequisites**:
    *   Python 3.9+
    *   `tkinter` (usually included with Python, but may need separate installation on Linux, e.g., `sudo apt-get install python3-tk`)

2.  **Dependencies**:
    Install the required Python packages:
    ```bash
    pip install -r requirements.txt
    ```
    *(Note: If `requirements.txt` is not provided, key dependencies include `pandas`, `geopandas`, `matplotlib`, `pyproj`, `shapely`, `pyyaml`)*

## Usage

The tool is launched via `main.py`. It attempts to start the GUI by default but will fall back to batch mode if no display is detected or if `--no-gui` is specified.

### 1. Graphical User Interface (GUI)

Simply run the script without arguments (or with an initial file) to open the GUI:

```bash
python3 main.py
# OR load a file on startup
python3 main.py --filepath /path/to/emissions.csv
```

**GUI Features:**
*   **Input**: Select your emissions file, county shapefile, and optional GRIDDESC file.
*   **Settings**: Choose plot type (County/Grid), pollutant, colormap, scale (Linear/Log), and more.
*   **Preview**: View a text preview of the loaded data header.
*   **Plot**: Click "Plot" to generate an interactive map window.

### 2. Batch Mode (Headless)

Generate maps automatically without opening a window. Use `--no-gui` to force batch mode.

**Basic Example:**
```bash
python3 main.py --no-gui \
  --filepath /path/to/emissions.csv \
  --county-shapefile /path/to/counties.gpkg \
  --pollutant "NOX,VOC" \
  --outdir ./maps
```

**Grid Plotting Example:**
```bash
python3 main.py --no-gui \
  --pltyp grid \
  --griddesc /path/to/GRIDDESC \
  --gridname 12US1_36-12-4 \
  --filepath /path/to/emissions.csv \
  --pollutant CO \
  --outdir ./grid_maps
```

### 3. Configuration Files (JSON / YAML)

You can save your run settings to a file (automatically done in batch mode) and reuse them later. This is ideal for repeating complex runs.

**Using a YAML Configuration:**
```bash
python3 main.py --yaml config.yaml
```

**Re-importing Processed Data:**
If you have already processed a large dataset and saved it (via `--export-csv`), you can skip the raw data parsing step by using `--reimport` with your config file:

```bash
python3 main.py --yaml config.yaml --reimport
```

## Configuration File Structure (YAML)

A typical YAML configuration file looks like this:

```yaml
timestamp_utc: '2025-01-01T12:00:00Z'
arguments:
  filepath: /path/to/input.csv       # Input emissions file
  sector: my_sector                  # Sector label
  filter_col: region_cd              # Column to filter by
  filter_val: ['37001', '37003']     # Values to keep
  county_shapefile: /path/to/shp.gpkg
  pltyp: county                      # 'county' or 'grid'
  pollutant: NOX,VOC                 # Pollutants to plot
  cmap: jet                          # Colormap
  log_scale: true                    # Logarithmic scale
  outdir: ./outputs                  # Output directory
  export_csv: true                   # Save processed data to CSV
  # ... other arguments matching command-line flags
outputs:
  # ... (generated by the tool)
```

## Command Line Arguments

| Argument | Description |
| :--- | :--- |
| `--filepath` | Path to input emissions file (CSV, TXT, LST). |
| `--sector` | Sector name (used for output filenames). |
| `--no-gui` | Force batch mode (do not open window). |
| `--yaml` | Load settings from a YAML configuration file. |
| `--json` | Load settings from a JSON configuration file. |
| `--reimport` | Reuse pre-processed data defined in the config file. |
| `--outdir` | Directory to save output maps and files. |
| `--pollutant` | Comma-separated list of pollutants to plot. |
| `--pltyp` | Plot type: `county` or `grid`. |
| `--county-shapefile` | Path to county boundary shapefile. |
| `--griddesc` | Path to GRIDDESC file (required for grid plots). |
| `--gridname` | Name of the grid in GRIDDESC. |
| `--filter-col` | Column name to filter data by. |
| `--filter-val` | Value(s) to keep in the filter column. |
| `--log-scale` | Use logarithmic color scale. |
| `--cmap` | Matplotlib colormap name (e.g., `viridis`, `jet`). |
| `--bins` | Custom bin edges for the colorbar. |
| `--zoom-to-data` | Zoom map extent to where data exists. |
| `--export-csv` | Export the processed DataFrame to CSV. |

## Troubleshooting

*   **"No module named 'tkinter'"**: Install the python-tk package for your OS.
*   **"No module named 'yaml'"**: Install PyYAML: `pip install PyYAML`.
*   **Display Issues**: If running on a remote server without X11 forwarding, use `--no-gui`.
